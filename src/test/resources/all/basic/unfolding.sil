
var f: Int
var next: Ref

predicate valid(r: Ref) {
    acc(r.f, write) && acc(r.next, write) && ((r.next != null) ==> (acc(r.next.valid(), write)))
}

method t1(r: Ref)
    requires acc(r.valid(), write)
{
    var i: Int := unfolding acc(r.valid(), write) in (r.f)
}

method t2(r: Ref)
    requires r != null
{
    //:: ExpectedError(assignment.failed:insufficient.permission)
    var i: Int := unfolding acc(r.valid(), write) in (r.f)
}

method t3(r: Ref)
    requires acc(r.valid(), write)
{
    //:: ExpectedError(assignment.failed:insufficient.permission)
    var i: Int := (unfolding acc(r.valid(), write) in (unfolding acc(r.valid(), write) in (r.f)))
}
